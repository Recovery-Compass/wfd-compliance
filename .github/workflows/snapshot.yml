name: Dashboard Snapshot Generator

on:
  workflow_dispatch:
  push:
    paths:
      - 'docs/dashboards/**/*.html'

jobs:
  generate-snapshots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install --with-deps chromium
          
      - name: Generate PNG and PDF snapshots
        run: |
          cat > capture.mjs << 'EOF'
          import { chromium } from 'playwright';
          import { fileURLToPath } from 'url';
          import { dirname, join } from 'path';

          const __dirname = dirname(fileURLToPath(import.meta.url));

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage({
              viewport: { width: 1920, height: 1080 }
            });
            
            // Load from live GitHub Pages URL
            const liveUrl = 'https://recovery-compass.github.io/wfd-compliance/dashboards/khpoa-aps-nov02/dashboard.html';
            console.log(`Loading ${liveUrl}...`);
            
            try {
              await page.goto(liveUrl, { waitUntil: 'networkidle', timeout: 30000 });
              
              // Wait for rendering
              await page.waitForTimeout(2000);
              
              // Get full page height
              const bodyHeight = await page.evaluate(() => document.body.scrollHeight);
              await page.setViewportSize({ width: 1920, height: Math.max(bodyHeight, 1080) });
              
              // Generate PNG
              const pngPath = 'docs/dashboards/khpoa-aps-nov02/dashboard.png';
              await page.screenshot({ 
                path: pngPath, 
                fullPage: true 
              });
              console.log(`âœ… PNG saved: ${pngPath}`);
              
              // Generate PDF
              const pdfPath = 'docs/dashboards/khpoa-aps-nov02/dashboard.pdf';
              await page.pdf({ 
                path: pdfPath,
                format: 'Letter',
                printBackground: true,
                margin: { top: '0.5in', right: '0.5in', bottom: '0.5in', left: '0.5in' }
              });
              console.log(`âœ… PDF saved: ${pdfPath}`);
              
            } catch (error) {
              console.error(`âŒ Error: ${error.message}`);
              process.exit(1);
            }
            
            await browser.close();
          })();
          EOF
          
          npx playwright install chromium
          node capture.mjs
          
      - name: Commit snapshots
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add docs/dashboards/khpoa-aps-nov02/dashboard.png docs/dashboards/khpoa-aps-nov02/dashboard.pdf
          git diff --staged --quiet || git commit -m "Add dashboard PNG and PDF snapshots"
          git push origin main
          
      - name: Summary
        run: |
          echo "## ðŸ“¸ Snapshots Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PNG: https://recovery-compass.github.io/wfd-compliance/dashboards/khpoa-aps-nov02/dashboard.png" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… PDF: https://recovery-compass.github.io/wfd-compliance/dashboards/khpoa-aps-nov02/dashboard.pdf" >> $GITHUB_STEP_SUMMARY
